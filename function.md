# Azure Functions

## Defination:

Serverless: Rather than maintaining servers ourselves, we delegate it to 
- Automated scaling up
- Pay as you go model

### Choices for plans:

- Consumption Plan: 
    - Serverless
    - Automated Scale
    - TimesOut im 5 mins
    - Scales to Zero
    - Cold Start
    - Pay as you go
    - Billing is based on the number of executions, the duration of each execution, and the amount of memory used

- App Service Plan
    - VM Sharing
    - When you use App Service for other apps, your functions will run on the same plan (VMs) at no extra cost.
    - You may scale it out manually by adding more VM instances for an App Service plan.
    - You may also have autoscale enabled.
    - Optimal when you have existing, underutilized VMs, which also operate other instances of the App Service.
    - Traditional pricing model -- Pay monthly
    - No restrictions

- Premium Plan
    - Speed
    - The user has designated a set of pre-warmed cases, which are already online and ready to react instantly.
    - You pay for the constantly pre-warmed instances including any additional instances needed to scale the Azure app in/out.
    - Azure Functions host instances are added and removed based on the number of incoming events.
    - Enhanced Security 
    - Reserved Instances
    - Automatic scaling capabilities

- Docker Container
    - Can run on any premises
    - In any cloud

- Function.json file defines all the triggers and bindings used by an azure function

### Trigger
ONLY one trigger for a function
- HTTP trigger - use for API and webhooks
    - Any HTTP method
    - Route 
    - Can be secured via authorization key. There are three levels
        - Anonymous: no key required
        - Function: key per function
        - Admin: key per app (one key for all the functions in the app)
- Time trigger - use for schedule tasks
- Queue trigger - run in response to a message on a queue
	- you need to specify the path of the blob too with a binding expression
```
sample-workingItem/{name}
```
			- {name} will allow the function to access the file that triggered the function
		- 
- Cosmos DB trigger - runs when a document is created or updated
- Blob Trigger - run when a new file is uploaded to Blob Storage
- Event Grid
- Microsoft Graph
- Service Bus Queue - triggered by a message in a Bus Queue (messaging)
- Service Bus Topics - triggered by an event from Bus Topic (pub/sub)
- SendGrid - triggered by an email event in third-party service SendGrid

Trigger is input. Trigger will have type like ```httpTrigger``` 


### Binding

Bindings define if your function is connected to another service. The data from bindings is provided to the function as parameters. Bindings are optional, and a function can have multiple input and output bindings

All the inbound and outbound binding is stored in function.json for all the functions

- Input binding examples like: bobstorage, cosmos db binding, and microsoft graph binding
- Output binding examples: blobstorage, queue storage, cosmos dd, eventhub, servicehub, sendgrid 

### Storage Account

Every Fiunction app requires a storage account to operate. If that account is deleted, the function won't work. Function uses the following storage type:

![[./Pictures/function/Pasted image 20230228230136.png]]

### Azure Function file structure

![[./Pictures/function/Pasted image 20230228231225.png]]

### Authorization level

The authorization level can be one of the following values:
- anonymous-No API key is required.
- function-A function-specific API key is required (default value).
- admin-The master key is required.

### Logging

There are two ways to view a stream of log files being generated by your function executions
- Built-in log streaming
	the App Service platform lets you view a stream of your application log files.
- Live Metrics Stream
	when your function app is connected to Application Insights, you can view log data and other metrics in near real-time in the Azure portal using Live Metrics Stream

### Host.js

This configuration file contains global configurations options for all functions within the function app.

### function.json

In the function.json file and in function parameters and code, you can use binding expressions that resolve to values from various sources.

Types of binding expressions
 - App settings
- Trigger file name
- Trigger metadata
- JSON payloads
- New GUID
- Current date and time

![[./Pictures/function/Pasted image 20230301230531.png]]

![[./Pictures/function/Pasted image 20230301230807.png]]
![[./Pictures/function/Pasted image 20230301231037.png]]
![[./Pictures/function/Pasted image 20230301231204.png]]

### Local Settings

The Local Settings File stores app settings and settings used by local development tools. This file is called local.settings.json and is expected to be at the root of project folder

![[./Pictures/function/Pasted image 20230301232539.png]]

### Top Level commands
![[./Pictures/function/Pasted image 20230301232819.png]]

### Troubleshooting - Can't start runtime
- Storage account was deleted
- Storage account application settings were deleted
- Storage account credentials are invalid
- Storage account is inaccessible
- Daily execution quota is full
- App is behind a firewall

### Durable Function

Durable Functions is a serverless compute extension of Azure Functions that allows you to write stateful functions.

The extension introduces two types of functions:
1. Orchestrator function define stateful workflows (implicitly representing state via control flow.)
2. Entity function manage the state of an entity (explicitly representing state)

- They define workflows in code. No JSON schemas or designers are needed.
- They can call other functions synchronously and asynchronously.
	- The output from the called functions can be saved to local variables.
- They automatically checkpoint their progress whenever the function awaits.
	 - Local state is never lost if the process recycles or the VM reboots.
![[./Pictures/function/Pasted image 20230301234250.png]]

![[Pasted image 20230301234633.png]]

![[./Pictures/function/Pasted image 20230301234935.png]]